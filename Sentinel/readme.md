# Sentinel Alerting

## Overview

We can utilize Microsoft Sentinel to perform hunting, or past analysis, on the
indicators  that closely resemble the actions involved within this CVE
disclosure. A file type of “chm” (HTML compressed help file) and activity with "hh.exe".

This generalized alert is an odd behavior in our environment, but it can be
further filtered if desired using KQL.

## Logs

The raw logs in this directory are from <https://github.com/kagancapar/CVE-2022-29072> POC executing "cmd.exe" via a HTML file dragged over to the "Help Content" of 7-Zip. Once again, the POC does not include privilege escalation,but it does show how dragging a file onto the 7-Zip "Help Content" can launch a file referenced in the HTML in the file.

For reference, we used the raw logs of Event ID 4688 (Security channel) and 1 (Sysmon) to build some KQL.

Note: Logs presented are excluding information that we are not using for this demonstration purpose.

## Hunting Query

This is an ASIM query.

```kql
// search for an activity involving both "hh.exe" windows utility and a ".chm" file.
imProcess
| where TimeGenerated > ago(365d)
| where  
    ActingProcessName has "hh.exe" 
    and ActingProcessCommandLine matches regex @".*\.chm$" 
    //and TargetProcessName has_any ("cmd.exe","pwsh.exe","powershell.exe")
```

## Analytics Rule

Deploy an analytic rule to your workspace by using the buttons below. 

Note: These alerts are more generalized than strictly 7-Zip execution detection.

[![Deploy to Azure](https://aka.ms/deploytoazurebutton)](https://raw.githubusercontent.com/sentinelblue/CVE-2022-29072/main/Sentinel/cve-2022-29072_7-zip_priv_escalation.json)

[![Deploy to Azure Gov](https://aka.ms/deploytoazuregovbutton)](https://raw.githubusercontent.com/sentinelblue/CVE-2022-29072/main/Sentinel/cve-2022-29072_7-zip_priv_escalation.json)
