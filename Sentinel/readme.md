# Sentinel Alerting

## Overview

We can utilize Microsoft Sentinel to perform hunting, or past analysis, on the
indicators  that closely resemble the actions involved within this CVE
disclosure. A file type of “chm” (HTML compressed help file) and activity with "hh.exe".

This generalized alert is an odd behavior in our environment, but it can be
further filtered if desired using KQL.

⚠️⚠️
To utilize the below alert you need to have ASIM parsers (specifically the "Process Event" schema/parsers) installed to your Sentinel workspace. Deploy them via <https://github.com/Azure/Azure-Sentinel/tree/master/ASIM>
⚠️⚠️

## Logs

The raw logs in this directory are from <https://github.com/kagancapar/CVE-2022-29072>'s POC executing "cmd.exe" via a HTML file dragged over to the "Help Content" of 7-Zip. Once again, the POC does not include privilege escalation, but it does show how dragging a file onto the 7-Zip "Help Content" can launch a process referenced in the HTML of the file.

For reference, we also included the raw logs of Event ID 4688 (Security channel) and 1 (Sysmon) to build some KQL.

Note: Logs presented are excluding information that we are not using for this demonstration purpose.

## Hunting Query

This is an ASIM query. Refer to more queries in "[./hunting.kql](https://github.com/sentinelblue/CVE-2022-29072/blob/main/Sentinel/hunting.kql)".

```kql
imProcess
| where TimeGenerated > ago(365d)
| where  
    ActingProcessName has "hh.exe" 
    and ActingProcessCommandLine matches regex @".*\.chm$" 
```

## Analytics Rule

This is also an ASIM query.

Deploy an analytic rule to your workspace by using the buttons below.

Note: These alerts are more generalized than strictly 7-Zip execution detection. We are looking for any interaction between "hh.exe" and any ".chm" file.

### Updates

#### V1.1.0

Matched sigma rule from <https://github.com/kagancapar/CVE-2022-29072/blob/main/7z_CVE-2022-29072.yml>

#### V1.0.0

## Deploy to Azure Buttons

[Review the analytics here.](https://github.com/sentinelblue/CVE-2022-29072/blob/main/Sentinel/cve-2022-29072_7-zip_priv_escalation.yaml). Then deploy the Sentinel Analytics rule to your Sentinel workspace below.

[![Deploy to Azure](https://aka.ms/deploytoazurebutton)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fsentinelblue%2FCVE-2022-29072%2Fmain%2FSentinel%2Fcve-2022-29072_7-zip_priv_escalation.json)

[![Deploy to Azure Gov](https://aka.ms/deploytoazuregovbutton)](https://portal.azure.us/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fsentinelblue%2FCVE-2022-29072%2Fmain%2FSentinel%2Fcve-2022-29072_7-zip_priv_escalation.json)
