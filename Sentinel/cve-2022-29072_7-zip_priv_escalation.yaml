id: 2e6c6864-d264-468a-9477-dd5614c501c9
name: 7-Zip Privilege Escalation (Normalized Process Events)
description: |
  Detects possible exploitation vulnerability CVE-2022-29072. This vulnerability is due to 7z.dll misconfiguration. When a .7z file is placed in the Help > Contents area of the current Windows version 21.07, anyone with access to the host can elevate privileges. The command creates a child process of 7zFM.exe.
  References: 
    - https://github.com/kagancapar/CVE-2022-29072
severity: Medium
requiredDataConnectors: []
queryFrequency: 1d
queryPeriod: 1d
triggerOperator: gt
triggerThreshold: 0
tactics:
  - Execution
  - Persistence
tags:
  - Id: 56e02bce-934c-49c3-ba1e-976f6225a3a4
    version: 1.1.0
  - Schema: ASIMProcessEvent
    SchemaVersion: 0.1.0
  - 7-Zip

query:  |
  imProcess
  | where 
      (TargetProcessName has_any ("cmd.exe", "powershell.exe") and ActingProcessName matches regex @".*7zFM.exe$")
      and not(TargetProcessCommandLine has_any (".bat",".cmd",".ps1"))
  | project 
    TimeGenerated,
    Endpoint=Dvc,
    Process = TargetProcessName,
    ProcessCommandLine=TargetProcessCommandLine,
    ParentProcess=ActingProcessName,
    ParentProcessCommandLine=ActingProcessCommandLine,
    User,
    TargetProcessSHA256,
    EventStartTime,
    EventEndTime,
    EventType,
    EventResult,
    EventProduct,
    //EventSchema
    EventSchemaVersion,
    AlgorithmHash = "SHA256"
entityMappings:
  - entityType: Account
    fieldMappings:
      - identifier: FullName
        columnName: AccountCustomEntity
  - entityType: Host
    fieldMappings:
      - identifier: FullName
        columnName: HostCustomEntity
  - entityType: FileHash
    fieldMappings:
      - identifier: Algorithm
        columnName: AlgorithmCustomEntity
      - identifier: Value
        columnName: FileHashCustomEntity
version: 1.1.2
kind: Scheduled