id: 2e6c6864-d264-468a-9477-dd5614c501c9
name: 7-Zip Privilege Escalation (Normalized Process Events)
description: |
  Identifies usage of the Windows help file dialog and process creation.
  References: 
    - https://github.com/kagancapar/CVE-2022-29072
severity: Medium
requiredDataConnectors: []
queryFrequency: 1d
queryPeriod: 1d
triggerOperator: gt
triggerThreshold: 0
tactics:
  - Execution
  - Persistence
tags:
  - Id: 56e02bce-934c-49c3-ba1e-976f6225a3a4
    version: 1.0.0
  - Schema: ASIMProcessEvent
    SchemaVersion: 0.1.0
  - 7-Zip

query:  |
  imProcess
  | where TimeGenerated > ago(365d)
  | where  
    ActingProcessName has "hh.exe" 
    and ActingProcessCommandLine matches regex @".*\.chm$" 
    //and TargetProcessName has_any ("cmd.exe","pwsh.exe","powershell.exe")
  | project 
    TimeGenerated,
    Endpoint=Dvc,
    Process = TargetProcessName,
    ProcessCommandLine=TargetProcessCommandLine,
    ParentProcess=ActingProcessName,
    ParentProcessCommandLine=ActingProcessCommandLine,
    User,
    TargetProcessSHA256,
    EventStartTime,
    EventEndTime,
    EventType,
    EventResult,
    EventProduct,
    //EventSchema
    EventSchemaVersion
  | extend 
    timestamp = TimeGenerated,
    AccountCusomEntity = ParentProcess,
    HostCustomEntity = User,
    AlgorithmCustomEntit = "SHA256",
    FileHashCustomEntity = TargetProcessSHA256
entityMappings:
  - entityType: Account
    fieldMappings:
      - identifier: FullName
        columnName: AccountCustomEntity
  - entityType: Host
    fieldMappings:
      - identifier: FullName
        columnName: HostCustomEntity
  - entityType: FileHash
    fieldMappings:
      - identifier: Algorithm
        columnName: AlgorithmCustomEntity
      - identifier: Value
        columnName: FileHashCustomEntity
version: 1.1.2
kind: Scheduled